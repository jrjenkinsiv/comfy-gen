name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

# =============================================================================
# CI CONFIGURATION
# =============================================================================
# This CI runs on cerebro self-hosted runner (Mac mini, macOS 15.5).
# 
# Cerebro can reach moira (192.168.1.215) for integration tests with ComfyUI.
# The runner is registered for github-runner-manager repo - workflows from
# comfy-gen will fail until runner is re-registered organization-wide or
# added as a second repo listener.
#
# Runner: cerebro (self-hosted, macOS, ARM64)
# =============================================================================

jobs:
  # ============================================================================
  # Phase 1: Fast Checks (Syntax & Linting)
  # ============================================================================
  lint:
    name: Code Quality Checks
    runs-on: [self-hosted, macOS, ARM64]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install linting dependencies
        run: |
          /opt/homebrew/bin/python3.11 -m pip install --upgrade pip --user
          /opt/homebrew/bin/python3.11 -m pip install -r requirements-lint.txt --user
      
      - name: Python syntax check
        run: |
          echo "Checking Python syntax with py_compile..."
          /opt/homebrew/bin/python3.11 -m py_compile utils/*.py
          /opt/homebrew/bin/python3.11 -m py_compile scripts/*.py || echo "[WARN] Some scripts may have issues"
          /opt/homebrew/bin/python3.11 -m py_compile generate.py
          /opt/homebrew/bin/python3.11 -m py_compile mcp_server.py
          echo "[OK] Python syntax check passed"
      
      - name: Ruff lint
        run: |
          echo "Running ruff linter..."
          /opt/homebrew/bin/python3.11 -m ruff check . --output-format github
          echo "[OK] Ruff lint passed"
      
      - name: Ruff format check
        run: |
          echo "Checking code formatting..."
          /opt/homebrew/bin/python3.11 -m ruff format --check .
          echo "[OK] Format check passed"

  # ============================================================================
  # Phase 2: Type Checking
  # ============================================================================
  typecheck:
    name: Type Checking
    runs-on: [self-hosted, macOS, ARM64]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          /opt/homebrew/bin/python3.11 -m pip install --upgrade pip --user
          /opt/homebrew/bin/python3.11 -m pip install -r requirements-lint.txt --user
      
      - name: Run mypy
        run: |
          echo "Running mypy type checker..."
          /opt/homebrew/bin/python3.11 -m mypy utils/ --show-error-codes --pretty || echo "[WARN] Type errors found - review recommended"
          echo "[OK] Mypy check completed"

  # ============================================================================
  # Phase 3: Module Validation
  # ============================================================================
  validate:
    name: Module Validation
    runs-on: [self-hosted, macOS, ARM64]
    needs: lint
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          /opt/homebrew/bin/python3.11 -m pip install --upgrade pip --user
          # Install minimal deps for import validation
          /opt/homebrew/bin/python3.11 -m pip install requests pyyaml click Pillow minio httpx aiofiles --user
          /opt/homebrew/bin/python3.11 -m pip install -e . --user
      
      - name: Module import validation
        run: |
          echo "Running smoke tests..."
          /opt/homebrew/bin/python3.11 scripts/smoke_test.py
      
      - name: Workflow JSON validation
        run: |
          echo "Validating workflow JSON files..."
          /opt/homebrew/bin/python3.11 scripts/validate_workflows.py


  # ============================================================================
  # Phase 4: Unit Tests
  # ============================================================================
  test:
    name: Unit Tests
    runs-on: [self-hosted, macOS, ARM64]
    needs: lint
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          /opt/homebrew/bin/python3.11 -m pip install --upgrade pip --user
          /opt/homebrew/bin/python3.11 -m pip install -r requirements.txt --user
          /opt/homebrew/bin/python3.11 -m pip install pytest pytest-cov --user
          /opt/homebrew/bin/python3.11 -m pip install -e . --user
      
      - name: Run pytest
        run: |
          echo "Running pytest..."
          echo "Note: Integration tests marked @pytest.mark.integration are skipped"
          /opt/homebrew/bin/python3.11 -m pytest tests/ -v \
            -m "not integration" \
            --ignore=tests/manual_test_*.py \
            --ignore=tests/test_error_handling_manual.sh \
            --tb=short \
            || echo "[WARN] Some tests failed - check logs"
      
      - name: Generate test summary
        if: always()
        run: |
          echo "# Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Platform: macOS ARM64 (cerebro self-hosted runner)" >> $GITHUB_STEP_SUMMARY
          echo "Integration tests: ENABLED (cerebro can reach moira:8188)" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # Summary Job
  # ============================================================================
  ci-summary:
    name: CI Summary
    runs-on: [self-hosted, macOS, ARM64]
    needs: [lint, typecheck, validate, test]
    if: always()
    steps:
      - name: Check results
        run: |
          echo "==================================="
          echo "CI Pipeline Summary"
          echo "==================================="
          echo ""
          echo "Runner: cerebro (self-hosted, macOS ARM64)"
          echo ""
          echo "Lint: ${{ needs.lint.result }}"
          echo "Type Check: ${{ needs.typecheck.result }}"
          echo "Validation: ${{ needs.validate.result }}"
          echo "Tests: ${{ needs.test.result }}"
          echo ""
          
          # Lint and validate must succeed; typecheck and test are advisory for now
          if [[ "${{ needs.lint.result }}" != "success" ]] || \
             [[ "${{ needs.validate.result }}" != "success" ]]; then
            echo "[ERROR] CI pipeline failed"
            exit 1
          else
            echo "[OK] Required checks passed!"
            if [[ "${{ needs.typecheck.result }}" != "success" ]] || \
               [[ "${{ needs.test.result }}" != "success" ]]; then
              echo "[WARN] Advisory checks have issues - review recommended"
            fi
          fi
      
      - name: Generate summary
        if: always()
        run: |
          echo "# CI Pipeline Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Runner" >> $GITHUB_STEP_SUMMARY
          echo "- **Primary:** cerebro (self-hosted, macOS ARM64)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Results" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status | Required |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|----------|" >> $GITHUB_STEP_SUMMARY
          echo "| Lint | ${{ needs.lint.result }} | Yes |" >> $GITHUB_STEP_SUMMARY
          echo "| Type Check | ${{ needs.typecheck.result }} | Advisory |" >> $GITHUB_STEP_SUMMARY
          echo "| Validation | ${{ needs.validate.result }} | Yes |" >> $GITHUB_STEP_SUMMARY
          echo "| Tests | ${{ needs.test.result }} | Advisory |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.lint.result }}" == "success" ]] && \
             [[ "${{ needs.validate.result }}" == "success" ]]; then
            echo "[OK] **Required checks passed!**" >> $GITHUB_STEP_SUMMARY
          else
            echo "[ERROR] **Required checks failed. Please review the logs.**" >> $GITHUB_STEP_SUMMARY
          fi
