{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://github.com/jrjenkinsiv/comfy-gen/categories/schema.json",
  "title": "ComfyGen Category Schema",
  "description": "Schema for category YAML files that define generation presets",
  "type": "object",
  "required": ["category"],
  "additionalProperties": false,
  "properties": {
    "category": {
      "type": "object",
      "required": ["id", "type", "display_name", "keywords"],
      "additionalProperties": false,
      "properties": {
        "id": {
          "type": "string",
          "pattern": "^[a-z][a-z0-9_]*$",
          "description": "Unique identifier (lowercase, underscores allowed)"
        },
        "type": {
          "type": "string",
          "enum": ["subject", "setting", "modifier", "style"],
          "description": "Category type for composition rules"
        },
        "display_name": {
          "type": "string",
          "description": "Human-readable name for UI"
        },
        "description": {
          "type": "string",
          "description": "Detailed description of this category"
        },
        "icon": {
          "type": "string",
          "description": "Emoji or icon identifier for UI"
        },
        "schema_version": {
          "type": "string",
          "pattern": "^\\d+\\.\\d+\\.\\d+$",
          "default": "1.0.0",
          "description": "Schema version this category adheres to"
        },
        "policy_tier": {
          "type": "string",
          "enum": ["general", "mature", "explicit"],
          "default": "general",
          "description": "Content policy tier for gating"
        },
        "keywords": {
          "type": "object",
          "required": ["primary"],
          "additionalProperties": false,
          "description": "Keywords for category detection",
          "properties": {
            "primary": {
              "type": "array",
              "items": {"type": "string"},
              "minItems": 1,
              "description": "Primary keywords (high confidence match)"
            },
            "secondary": {
              "type": "array",
              "items": {"type": "string"},
              "description": "Secondary keywords (medium confidence)"
            },
            "specific": {
              "type": "array",
              "items": {"type": "string"},
              "description": "Specific/rare keywords (exact match only)"
            }
          }
        },
        "prompts": {
          "type": "object",
          "additionalProperties": false,
          "description": "Prompt fragments to inject",
          "properties": {
            "positive_fragments": {
              "type": "object",
              "additionalProperties": false,
              "properties": {
                "required": {
                  "type": "array",
                  "items": {"type": "string"},
                  "description": "Always included in positive prompt"
                },
                "optional": {
                  "type": "array",
                  "items": {"type": "string"},
                  "description": "Included if compatible"
                }
              }
            },
            "negative_fragments": {
              "type": "object",
              "additionalProperties": false,
              "properties": {
                "required": {
                  "type": "array",
                  "items": {"type": "string"},
                  "description": "Always included in negative prompt"
                },
                "optional": {
                  "type": "array",
                  "items": {"type": "string"},
                  "description": "Included if compatible"
                }
              }
            }
          }
        },
        "loras": {
          "type": "object",
          "additionalProperties": false,
          "description": "LoRA recommendations for this category",
          "properties": {
            "required": {
              "type": "array",
              "items": {
                "$ref": "#/$defs/lora_spec"
              },
              "description": "LoRAs that must be used"
            },
            "recommended": {
              "type": "array",
              "items": {
                "$ref": "#/$defs/lora_spec"
              },
              "description": "LoRAs that improve quality"
            },
            "avoid": {
              "type": "array",
              "items": {"type": "string"},
              "description": "LoRA filenames to avoid (conflicts)"
            }
          }
        },
        "settings": {
          "type": "object",
          "additionalProperties": false,
          "description": "Generation parameter overrides",
          "properties": {
            "steps": {
              "type": "object",
              "additionalProperties": false,
              "properties": {
                "min": {"type": "integer", "minimum": 1},
                "max": {"type": "integer", "maximum": 150},
                "default": {"type": "integer"}
              }
            },
            "cfg": {
              "type": "object",
              "additionalProperties": false,
              "properties": {
                "min": {"type": "number", "minimum": 1.0},
                "max": {"type": "number", "maximum": 30.0},
                "default": {"type": "number"}
              }
            },
            "size": {
              "type": "object",
              "additionalProperties": false,
              "properties": {
                "width": {"type": "integer", "minimum": 64, "maximum": 4096},
                "height": {"type": "integer", "minimum": 64, "maximum": 4096},
                "aspect_ratio": {"type": "string", "pattern": "^\\d+:\\d+$"}
              }
            },
            "sampler": {"type": "string"},
            "scheduler": {"type": "string"},
            "denoise": {"type": "number", "minimum": 0.0, "maximum": 1.0}
          }
        },
        "workflows": {
          "type": "object",
          "additionalProperties": false,
          "description": "Workflow preferences",
          "properties": {
            "preferred": {
              "type": "array",
              "items": {"type": "string"},
              "description": "Preferred workflow files (in order)"
            },
            "required_capabilities": {
              "type": "array",
              "items": {"type": "string"},
              "description": "Capabilities workflow must have"
            },
            "excluded": {
              "type": "array",
              "items": {"type": "string"},
              "description": "Workflows to never use"
            }
          }
        },
        "composition": {
          "type": "object",
          "additionalProperties": false,
          "description": "Rules for combining with other categories",
          "properties": {
            "priority": {
              "type": "integer",
              "minimum": 0,
              "maximum": 100,
              "default": 50,
              "description": "Higher priority wins conflicts (0-100)"
            },
            "conflicts_with": {
              "type": "array",
              "items": {"type": "string"},
              "description": "Category IDs that conflict"
            },
            "requires": {
              "type": "array",
              "items": {"type": "string"},
              "description": "Category IDs that must also be present"
            },
            "enhances": {
              "type": "array",
              "items": {"type": "string"},
              "description": "Category IDs this enhances (synergy)"
            },
            "max_per_type": {
              "type": "integer",
              "minimum": 1,
              "description": "Max categories of same type to combine"
            }
          }
        }
      }
    }
  },
  "$defs": {
    "lora_spec": {
      "type": "object",
      "required": ["filename"],
      "additionalProperties": false,
      "properties": {
        "filename": {
          "type": "string",
          "description": "LoRA filename (with .safetensors)"
        },
        "strength": {
          "type": "number",
          "minimum": 0.0,
          "maximum": 2.0,
          "default": 0.8,
          "description": "LoRA strength"
        },
        "trigger_words": {
          "type": "array",
          "items": {"type": "string"},
          "description": "Keywords to add when using this LoRA"
        },
        "condition": {
          "type": "string",
          "description": "When to use (e.g., 'if nsfw', 'if photorealistic')"
        }
      }
    }
  }
}
